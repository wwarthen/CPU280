# CPU280 System Software

## Background

In the early 1990's, Tilmann Reh designed and produced a small number of single-board computers based on the Zilog Z280 CPU chip.
The Z280 CPU was a significant successor to the populate Zilog Z80 CPU.  However, the Z280 was never incorporated into any
commercially producted computer.  The CPU280 System represents the only known functional implementation of this CPU.

In 2016, Lamar Owens had a small new run of the CPU280 system PCB's created and is working with the RetroBrew Computers community
(see http://www.retrobrewcomputers.org) to recreate this historically interesting system.  The new PCBs have proven to be fully
functional.  This repository has been created to function as a central, version-controled location for ongoing development of
the system software supporting the CPU280 computer.

The system software is built upon Digital Research CP/M Plus.  Additionally, an adaptation of ZPM/ZCCP is also included.
ZPM/ZCCP is an operating system created by Simeon Cran that provides compatibility with both CP/M Plus and ZCPR3.

## Repository Contents

The contents of the repository are organized into the following directories:

| Directory | Description |
| --- | --- |
| **SYSTEM** | contains both the ROM firmware and the CP/M Plus OS adaptation |
| **FORMAT** | contains a custom floppy disk formatting tool for the CPU280 |
| **IDETEST** | contains a program to test the ECB-IDE companion board and IDE drives (German) |
| **ZPM3** | contains the ZPM OS adaptation |
| **ZCCP** | contains the ZCCP Command Processor that pairs with ZPM3 |
| **Tools** | contains assorted programs used to build the software via Windows command line |
| **Floppy** | contains scripts and files to create bootable floppy images |

This is the zsm branch.  This branch is minimally updated to build using ZSM instead of the
original PRE280 and SLR180 combination.

## Build Process

The build process currently assumes a Microsoft Windows environment (either 32 or 64 bit Windows).  It is entirely
possible to build under Linux (some people have done this), but will require adapting the build scripts.

In general, the software and firmware is built by opening a command prompt and issuing the command "Build"
in each of the following directories.  The build process has depencies, so it is necessary to follow the
specified order.  Some directories also have ReadMe.txt files that provide additional information.

If your system has more than just the CPU280 board, you **must** update the loader.mac and system.mac files
in the SYSTEM directory.  For example, if you want support for an IDE board, you need to change the "ide"
equate from false to true in **both** files.

To build the firmware and software, run the "Build" command in these directories in the order listed:

1. **FORMAT:** Creates the format.com program.  This build utilizes Turbo Pascal and requires manual
intervention -- see ReadMe.txt for more information.
2. **IDETEST:** Creates the idetest.com program.  This build utilizes Turbo Pascal and requires manual
intervention -- see ReadMe.txt for more information.
3. **SYSTEM:** Creates the ROM firmware for system booting and includes a ROM-based version of CP/M Plus.
The files system.odd and system.evn are produced in this step which are the odd and even portions
of the ROM firmware.  This step also produces the cpm3.sys program for inclusion on floppy boot disks.
Make sure to verify/edit the loader.mac and system.mac files before running "Build" here.
4. **ZPM3:** Creates the ZPM/ZCCP variant of the system.  It produces versions of system.odd and system.evn
that can be used as system ROM firmware if you want to boot ZPM/ZCCP from ROM.  This step also produces
a variant of cpm3.sys which contains ZPM for inclusion on boot floppy disks.
5. **Floppy:** Creates boot floppy images.  Two floppy images are created: 1) CP/M Plus, and 2) ZPM/ZCCP.
Both images are bootable and can be written to a standard IBM 1.44MB formatted floppy disk with a tool
such as RawWrite for Windows.

## Change Log

### Version 2.20

Resurrection and baseline of original code.

1. Fixed minor issue with floppy boot process.

### Version 2.21

#### ZSM Conversion

Modified build process to use ZSM assembler from Hector Peraza.  All changes were contributed by Hector and are described below.

1. Replaced ++ and -- in Z280 instructions by + and - (the ++ and -- were used as hints for the pre280 preprocessor to generate long versions of some Z280 instructions; they are not an official Zilog syntax. ZSM4 can determine the operand size automatically).

2. The 'defb' instructions generated by pre280 were removed from the include (*.mac) files and the original Z280 instructions restored (a limitation of pre280 is that include files needed to be processed separately, and the top module has to include the modified copy and not the original).

3. Relational operators such as =, >, <=, etc. in conditionals were replaced by eq, gt, le, etc. respectively (the = > <= forms are an extension of the SLR180 assembler and were not implemented in ZSM4 because they conflict with the syntax of Z280 mnemonics)

4. The diskio.280 contains the following lines:
```
TransA:	defb	1,3,5,7,9,11,2,4,6,8,10,
        ...
TransB:	defb	1,3,5,7,9,11,2,4,6,8,10,
        ...
TransC:	defb	1,3,5,7,9,11,2,4,6,8,10,
        ...
TransD:	defb	1,3,5,7,9,11,2,4,6,8,10,
```
note the extra comma at the end. The comma is superfluous and was removed, as it triggers a syntax error in ZSM4.

5. In the ldrio.* files there are a couple of macro definitions that end like this:
```
	exit:	endm
```
a label before 'endm' is accepted by SLR180, but not by ZSM4/M80/RMAC; 'endm' is now simply moved to the next line.

6. In loader.280 the following statement can be found:
```
	ld	b,ValNum
```
where ValNum is an external variable. The problem is that the standard REL file format does not allow external 8-bit values. The instruction was therefore modified:
```
	ld	bc,ValNum
	ld	b,c
```
7. Again in loader.280, 'Boot' must be declared as PUBLIC (e.g. by using a double-colon), as it is referenced by the kernel.280 module.
Renamed ldos.mrl to ldos.rel (old ldos.rel deleted, as it was meant for SLRNK and therefore was not in the standard REL format)

8. Linking of both the loader and the BIOS is now done with Digital Research's LINK. That means that pre280 is no longer necessary, neither are SLR180 nor SLRNK.

The Windows Build scripts were modified and Linux scripts were added.

#### English Comments

Incorporated source from Tony Nicholson which converts all comments to English.

## Additional Information

The best source of information for this project is the RetroBrew Computers Community Forum which can be found
at http://www.retrobrewcomputers.org/forum/
